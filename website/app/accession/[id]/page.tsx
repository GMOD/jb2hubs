import path from 'path'

import { Metadata } from 'next'
import ReactMarkdown from 'react-markdown'
import slugify from 'slugify'

import { getAccessionById, getAllAccessions } from '../../../lib/api.ts'
import { StyledLink } from '../../components/ui/Link.tsx'
import { LI, UL } from '../../components/ui/List.tsx'
import { H1, H2, H4, Italic } from '../../components/ui/Typography.tsx'
import { tryAndReadJSON, tryAndReadText } from '../../components/util.ts'

export async function generateMetadata({
  params,
}: {
  params: Promise<{ id: string }>
}): Promise<Metadata> {
  const { id } = await params
  const ret = await getAccessionById(id)
  if (!ret) {
    throw new Error(`${id} not found`)
  }
  return {
    title: ret.scientificName,
  }
}

export default async function Page({
  params,
}: {
  params: Promise<{ id: string }>
}) {
  const { id } = await params
  const ret = await getAccessionById(id)
  if (!ret) {
    throw new Error('accession not found')
  }

  const { scientificName } = ret
  const [base, rest] = id.split('_')
  const [b1, b2, b3] = rest!.match(/.{1,3}/g)!
  const folder = `hubs/${base}/${b1}/${b2}/${b3}/${id}`
  // @ts-expect-error
  const { description } = await tryAndReadJSON<{ description: string }>(
    path.join(process.cwd(), folder, 'description.json'),
  )

  const imgBase = path.join(
    process.cwd(),
    'speciesImages',
    slugify(scientificName),
  )

  const val = await tryAndReadText(imgBase + '.txt')
  const source = await tryAndReadText(imgBase + '_page.txt')
  return (
    <div className="flex flex-col items-center">
      <div className="w-full px-4 sm:px-6 md:px-8 lg:w-1/2 lg:px-0">
        <div className="relative">
          <H1>{scientificName}</H1>
          <H4>Accession: {ret.accession}</H4>
          <H4>Assembly name: {ret.ncbiAssemblyName}</H4>
          <H4>Common name: {ret.commonName}</H4>

          {val ? (
            <div className="float-right ml-6 mb-4 max-w-xs">
              <figure className="m-0">
                <img src={val} className="max-w-full" />
                <figcaption>
                  {source ? (
                    <StyledLink href={source} external>
                      (source)
                    </StyledLink>
                  ) : (
                    'no link'
                  )}
                </figcaption>
              </figure>
            </div>
          ) : null}

          {description ? (
            <div>
              <H2>Species description</H2>
              <div className="space-y-4">
                <ReactMarkdown>{description}</ReactMarkdown>
                <div>
                  <Italic>
                    (description generated by AI,{' '}
                    <StyledLink
                      href="https://github.com/cmdcolin/jb2hubs/"
                      external
                    >
                      report errors or suggestions here
                    </StyledLink>
                    . This is a species level description, not of the particular
                    genome assembly)
                  </Italic>
                </div>
              </div>
            </div>
          ) : null}
        </div>

        <div>
          <H2>Genome browsers</H2>
          <UL>
            <LI>
              <StyledLink href={ret.jbrowseLink} external>
                JBrowse{' '}
              </StyledLink>
            </LI>
            <LI>
              <StyledLink href={ret.igvBrowserLink} external>
                IGV.js
              </StyledLink>
            </LI>
            <LI>
              <StyledLink href={ret.ncbiBrowserLink} external>
                NCBI GDV
              </StyledLink>
            </LI>
            <LI>
              <StyledLink href={ret.ucscBrowserLink} external>
                UCSC
              </StyledLink>
            </LI>
          </UL>
        </div>
        <div>
          <H2>Portals/data downloads</H2>
          <UL>
            <LI>
              <StyledLink href={ret.ucscDataLink} external>
                UCSC hub folder
              </StyledLink>
            </LI>
            <LI>
              <StyledLink href={ret.ncbiLink} external>
                NCBI assembly page
              </StyledLink>
            </LI>
            <LI>
              <StyledLink
                href={`https://www.ncbi.nlm.nih.gov/datasets/taxonomy/${ret.taxonId}/`}
                external
              >
                NCBI datasets taxonomy page
              </StyledLink>
            </LI>
          </UL>
        </div>
      </div>
    </div>
  )
}

export async function generateStaticParams() {
  const posts = await getAllAccessions()
  return posts.map(post => ({
    id: post.id,
  }))
}
